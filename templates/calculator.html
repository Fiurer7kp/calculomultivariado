<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Calculadora Multivariada — GeoGebra Suite</title>

    <!-- Librería que sí está cargando correctamente para cálculos y gráficos -->
    <script src="https://cdn.plot.ly/plotly-2.26.2.min.js"></script>

    <style>
        * { box-sizing: border-box; margin:0; padding:0; font-family: Arial, sans-serif; }
        body { background:#2c3e50; min-height:100vh; display:flex; justify-content:center; align-items:flex-start; padding:20px; }
        .calculator { background:white; border-radius:10px; box-shadow:0 0 20px rgba(0,0,0,0.5); width:980px; max-width:98vw; }
        .header { background:#34495e; color:white; padding:15px; text-align:center; border-radius:10px 10px 0 0; }
        .content { display:grid; grid-template-columns: 1fr 340px; gap:12px; padding:15px; }
        .graph-panel { background:#ecf0f1; padding:10px; border-radius:5px; }
        #graph2d { width:100%; height:300px; background:white; border-radius:4px; }
        #graph3d { width:100%; height:300px; background:white; border-radius:4px; margin-top:10px; }
        .calc-panel { background:#bdc3c7; padding:10px; border-radius:5px; max-height: 680px; overflow-y: auto; }
        .display { background:#1a1a1a; color:#00ff00; font-size:16px; padding:10px; border-radius:5px; text-align:right; min-height:44px; font-family:'Courier New', monospace; overflow-x:auto; }
        .small { font-size:12px; color:#222; margin-bottom:6px; text-align:center; }
        .buttons { display:grid; grid-template-columns: repeat(5, 1fr); gap:6px; margin-top:8px; }
        button { padding:10px 6px; font-size:14px; border:none; border-radius:6px; cursor:pointer; background:#ecf0f1; transition: background-color 0.2s; }
        button:hover { filter: brightness(0.9); }
        .number { background:#e9ecef; }
        .operation { background:#3498db; color:white; }
        .function { background:#e67e22; color:white; }
        .equals { background:#2ecc71; color:white; grid-column: span 1; }
        .clear { background:#e74c3c; color:white; }
        .session-buttons { display:flex; gap:10px; justify-content:center; margin-top:10px; }
        .session-btn { padding:8px 12px; border:none; border-radius:15px; font-weight:bold; cursor:pointer; }
        .assign { background:#3498db; color:white; }
        .login { background:#2ecc71; color:white; }
        .help { font-size:12px; margin-top:8px; color:#222; }
        .controls { margin-top:8px; display:flex; gap:8px; align-items:center; justify-content:space-between; flex-wrap: wrap;}
        .range-inputs { display:flex; gap:6px; align-items:center; flex-wrap:wrap; }
        input[type="text"], input[type="number"], select { padding:6px; border-radius:6px; border:1px solid #999; }
        /* Panel de análisis */
        .analysis-panel { background:#ffffff; border-radius:6px; padding:10px; margin-top:10px; min-height:90px; box-shadow:0 0 6px rgba(0,0,0,0.08); }
        .analysis-title { font-weight:bold; margin-bottom:6px; color:#2c3e50; }
        /* Modal de ejemplos */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .modal-content { background: #fff; border-radius: 8px; width: 880px; max-width: 95vw; max-height: 85vh; overflow: auto; box-shadow: 0 12px 28px rgba(0,0,0,0.3); }
        .modal-header { display:flex; justify-content:space-between; align-items:center; padding:12px 16px; background:#34495e; color:#fff; border-radius:8px 8px 0 0; }
        .modal-body { padding: 12px 16px; }
        .examples-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .examples-card { background:#f8f9fa; border:1px solid #e1e4e8; border-radius:8px; padding:10px; }
        .examples-card h5 { margin-bottom:8px; color:#2c3e50; }
        .examples-card .buttons { grid-template-columns: repeat(2, 1fr); }
    </style>
</head>
<body>
    <div class="calculator">
        <div class="header">
            <h2>GeoGebra Suite — Calculadora Multivariada</h2>
            <p>Evaluación numérica + gráficos 2D y 3D (Implementación con Plotly)</p>
        </div>

        <div class="content">
            <div class="graph-panel">
                <h4>Gráfica 2D (y = f(x))</h4>
                <div id="graph2d"></div>

                <h4 style="margin-top:10px">Gráfica 3D (z = f(x,y))</h4>
                <div id="graph3d"></div>
                <div id="analysisPanel" class="analysis-panel">
                    <div class="analysis-title">Resultados y análisis</div>
                    <div id="analysisContent">Usa "Optimizar f(x,y)" para ver gradiente y puntos críticos.</div>
                </div>
            </div>

            <div class="calc-panel">
                <div class="display" id="display">0</div>
                <div class="small">Expr: usa x, y, z. Ej: sin(x) + x^2  — Asignaciones: a=3  — ¡ADVERTENCIA! No soporta derivadas o simplificación simbólica.</div>

                <div class="buttons">
                    <!-- fila 1 -->
                    <button class="function" onclick="addToDisplay('x')">x</button>
                    <button class="function" onclick="addToDisplay('y')">y</button>
                    <button class="function" onclick="addToDisplay('z')">z</button>
                    <button class="function" onclick="addToDisplay('Math.PI')">π</button>
                    <button class="function" onclick="addToDisplay('Math.E')">e</button>

                    <!-- fila 2 -->
                    <button class="function" onclick="addToDisplay('Math.sin(')">sin</button>
                    <button class="function" onclick="addToDisplay('Math.cos(')">cos</button>
                    <button class="function" onclick="addToDisplay('Math.tan(')">tan</button>
                    <button class="function" onclick="addToDisplay('Math.log(')">ln</button>
                    <button class="function" onclick="addToDisplay('Math.sqrt(')">√</button>

                    <!-- fila 3 -->
                    <button class="number" onclick="addToDisplay('7')">7</button>
                    <button class="number" onclick="addToDisplay('8')">8</button>
                    <button class="number" onclick="addToDisplay('9')">9</button>
                    <button class="operation" onclick="addToDisplay('/')">÷</button>
                    <button class="operation" onclick="addToDisplay('*')">×</button>

                    <!-- fila 4 -->
                    <button class="number" onclick="addToDisplay('4')">4</button>
                    <button class="number" onclick="addToDisplay('5')">5</button>
                    <button class="number" onclick="addToDisplay('6')">6</button>
                    <button class="operation" onclick="addToDisplay('-')">−</button>
                    <button class="operation" onclick="addToDisplay('+')">+</button>

                    <!-- fila 5 -->
                    <button class="number" onclick="addToDisplay('1')">1</button>
                    <button class="number" onclick="addToDisplay('2')">2</button>
                    <button class="number" onclick="addToDisplay('3')">3</button>
                    <button class="function" onclick="addToDisplay('**')">^</button>
                    <button class="function" onclick="addToDisplay('(')">(</button>

                    <!-- fila 6 -->
                    <button class="function" onclick="addToDisplay(')')">)</button>
                    <button class="function" onclick="addToDisplay(',')">,</button>
                    <button class="number" onclick="addToDisplay('.')">.</button>
                    <button class="function" onclick="useAns()">ans</button>
                    <button class="clear" onclick="clearDisplay()">C</button>

                    <!-- fila 7 -->
                    <button class="operation" onclick="backspace()">⌫</button>
                    <button class="function" onclick="assignVariable()">ASIG</button>
                    <button class="function" onclick="alert('Funcionalidad simbólica (derivadas) no disponible sin math.js')">∂/∂x</button>
                    <button class="function" onclick="alert('Funcionalidad simbólica (derivadas) no disponible sin math.js')">∂/∂y</button>
                    <button class="equals" onclick="calculate()">=</button>

                    <!-- fila 8 -->
                    <button class="function" onclick="plot2D()">Graficar 2D</button>
                    <button class="function" onclick="plot3D()">Graficar 3D</button>
                    <button class="function" onclick="clearGraphs()">Limpiar gráficas</button>
                    <button class="login" onclick="toggleLogin()">ABRIR SESIÓN</button>
                    <button class="function" onclick="helpDialog()">Ayuda</button>
                </div>

                <!-- Herramientas avanzadas de Cálculo Multivariado -->
                <div class="buttons" style="margin-top:12px">
                    <button class="function" onclick="insertFx('x')">F(x)</button>
                    <button class="function" onclick="insertFx('xy')">F(x,y)</button>
                    <button class="function" onclick="plotLine2D()">Recta 2D</button>
                    <button class="function" onclick="plotLine3D()">Recta 3D</button>
                    <button class="function" onclick="plotPlane3D()">Plano 3D</button>
                    <button class="function" onclick="plotImplicit3D()">Superficie implícita</button>
                    <button class="equals" onclick="optimizeFn()">Optimizar f(x,y)</button>
                    <button class="function" onclick="openExamples()">Ejemplos</button>
                </div>

                <div class="buttons" style="margin-top:6px">
                    <button class="function" onclick="loadQuadric('sphere')">Esfera</button>
                    <button class="function" onclick="loadQuadric('ellipsoid')">Elipsoide</button>
                    <button class="function" onclick="loadQuadric('paraboloid')">Paraboloide</button>
                    <button class="function" onclick="loadQuadric('hyperboloid1')">Hiperboloide 1 hoja</button>
                    <button class="function" onclick="loadQuadric('hyperboloid2')">Hiperboloide 2 hojas</button>
                </div>

                <div class="buttons" style="margin-top:6px">
                    <button class="function" onclick="analyzeDomainRange()">Dominio/Rango</button>
                    <button class="function" onclick="computeLimit2D()">Límite en (a,b)</button>
                    <button class="function" onclick="showDerivatives()">Derivadas/Gradiente</button>
                    <button class="function" onclick="lagrangeOptimize()">Optimización con Lagrange</button>
                    <button class="function" onclick="integralDouble()">Integral doble</button>
                    <button class="function" onclick="integralTriple()">Integral triple</button>
                </div>

                <!-- Atajos con símbolos ∬ y ∭ -->
                <div class="buttons" style="margin-top:6px">
                    <button class="function" title="Integral doble" onclick="integralDouble()">∬</button>
                    <button class="function" title="Integral triple" onclick="integralTriple()">∭</button>
                </div>

                <div class="controls">
                    <div class="range-inputs">
                        <label> x ∈ <input id="xmin" type="number" value="-5" style="width:70px"/> : <input id="xmax" type="number" value="5" style="width:70px"/></label>
                        <label> y ∈ <input id="ymin" type="number" value="-5" style="width:70px"/> : <input id="ymax" type="number" value="5" style="width:70px"/></label>
                    </div>
                    <div class="range-inputs" style="gap:12px">
                        <label>Resolución 2D: <input id="res2d" type="number" value="120" min="40" max="400" style="width:80px"/></label>
                        <label>Resolución 3D: <input id="res3d" type="number" value="40" min="10" max="150" style="width:80px"/></label>
                    </div>
                </div>

                <!-- Parámetros de análisis (ordenados y con atajos) -->
                <style>
                  .analysis-controls{margin-top:8px; background:#eef2f5; padding:10px; border-radius:8px;}
                  .analysis-grid{display:grid; grid-template-columns: repeat(2, 1fr); gap:10px;}
                  .analysis-block{background:#fff; border:1px solid #dde1e6; border-radius:8px; padding:8px; box-shadow:0 2px 6px rgba(0,0,0,0.05);} 
                  .analysis-block h5{margin-bottom:6px; color:#2c3e50; font-size:14px;}
                  .analysis-row{display:flex; align-items:center; gap:6px; flex-wrap:wrap;}
                  .analysis-row label{font-size:13px; color:#333;}
                </style>
                <div class="analysis-controls">
                  <div class="analysis-grid">
                    <div class="analysis-block">
                      <h5>Visualización</h5>
                      <div class="analysis-row">
                        <button class="function" onclick="drawContours2D()">Contornos 2D</button>
                        <button class="function" onclick="drawHeatmap2D()">Heatmap 2D</button>
                        <button class="function" onclick="centerCamera3D()">Centrar cámara 3D</button>
                        <button class="function" onclick="exportGraphs()">Exportar PNG</button>
                      </div>
                      <div class="small">Contornos/heatmap usan f(x,y); exporta 2D/3D si existen.</div>
                    </div>
                    <div class="analysis-block">
                      <h5>Límite en (a,b)</h5>
                      <div class="analysis-row">
                        <label>a <input id="limitAx" type="number" value="0" style="width:80px"/></label>
                        <label>b <input id="limitBy" type="number" value="0" style="width:80px"/></label>
                        <button class="function" onclick="computeLimit2D()">Calcular</button>
                      </div>
                      <div class="small">Enter en a/b ejecuta el cálculo y marca el punto.</div>
                    </div>
                    <div class="analysis-block">
                      <h5>Derivadas/Gradiente (x,y)</h5>
                      <div class="analysis-row">
                        <label>x <input id="derivX" type="number" placeholder="opcional" style="width:80px"/></label>
                        <label>y <input id="derivY" type="number" placeholder="opcional" style="width:80px"/></label>
                        <button class="function" onclick="showDerivatives()">Derivar</button>
                      </div>
                      <div class="small">Enter en x/y ejecuta derivadas (si se indica punto).</div>
                    </div>
                    <div class="analysis-block">
                      <h5>Restricción g(x,y) = 0 (Lagrange)</h5>
                      <div class="analysis-row">
                        <input id="lagrangeG" type="text" value="x + y = 1" style="flex:1; min-width:220px"/>
                        <button class="function" onclick="lagrangeOptimize()">Resolver</button>
                      </div>
                      <div class="small">Enter en el campo ejecuta la optimización.</div>
                    </div>
                    <div class="analysis-block">
                      <h5>Dominio y Rango</h5>
                      <div class="analysis-row">
                        <button class="function" onclick="analyzeDomainRange()">Calcular dominio/rango</button>
                        <button class="function" onclick="drawDomainMask2D()">Graficar dominio (2D)</button>
                      </div>
                      <div class="small">Usa los rangos x/y de arriba para el muestreo.</div>
                    </div>
                    <div class="analysis-block">
                      <h5>∬ Límites rectangulares</h5>
                      <div class="analysis-row">
                        <label>x [<input id="int2dxA" type="number" value="-1" style="width:70px"/>, <input id="int2dxB" type="number" value="1" style="width:70px"/>]</label>
                        <label>y [<input id="int2dyC" type="number" value="-1" style="width:70px"/>, <input id="int2dyD" type="number" value="1" style="width:70px"/>]</label>
                        <button class="function" onclick="integralDouble()">Calcular ∬</button>
                      </div>
                      <div class="small">Se dibuja el rectángulo en la gráfica 2D.</div>
                    </div>
                    <div class="analysis-block">
                      <h5>∭ Límites rectangulares</h5>
                      <div class="analysis-row">
                        <label>x [<input id="int3dxA" type="number" value="-1" style="width:70px"/>, <input id="int3dxB" type="number" value="1" style="width:70px"/>]</label>
                        <label>y [<input id="int3dyC" type="number" value="-1" style="width:70px"/>, <input id="int3dyD" type="number" value="1" style="width:70px"/>]</label>
                        <label>z [<input id="int3dzE" type="number" value="-1" style="width:70px"/>, <input id="int3dzF" type="number" value="1" style="width:70px"/>]</label>
                        <button class="function" onclick="integralTriple()">Calcular ∭</button>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="session-buttons">
                    <button class="session-btn assign" onclick="openAssignModal()">Variables</button>
                    <button class="session-btn login" onclick="toggleLogin()">ABRIR SESIÓN</button>
                </div>

                <div class="help" id="helptext">
                    Consejos: Para gráficos 2D, usa 'x' (ej: Math.sin(x)). Para 3D usa 'x' e 'y' (ej: x**2 + y**2).
                </div>
            </div>
        </div>
    </div>

<!-- Modal de Ejemplos -->
<div id="examplesModal" class="modal" onclick="closeExamples(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <div class="modal-header">
      <div>Catálogo de ejemplos (click y listo)</div>
      <button class="clear" onclick="closeExamples()">Cerrar ×</button>
    </div>
    <div class="modal-body">
      <div class="examples-grid">
        <div class="examples-card">
          <h5>Visualización z = f(x,y)</h5>
          <div class="buttons">
            <button class="function" onclick="examplePlot3D('x**2 + 2*y**2')">x^2 + 2*y^2</button>
            <button class="function" onclick="examplePlot3D('sin(x) * cos(y)')">sin(x)*cos(y)</button>
            <button class="function" onclick="examplePlot3D('sqrt(25 - x**2 - y**2)')">sqrt(25 - x^2 - y^2)</button>
            <button class="function" onclick="examplePlot3D('x*y')">silla: x*y</button>
            <button class="function" onclick="examplePlot3D('exp(-(x**2 + y**2))')">gaussiana: e^{-(x^2+y^2)}</button>
            <button class="function" onclick="examplePlot3D('sin(x**2 + y**2)')">ondas: sin(x^2+y^2)</button>
            <button class="function" onclick="examplePlot3D('x**2 - y**2')">hiperboloide: x^2 − y^2</button>
          </div>
        </div>
        <div class="examples-card">
          <h5>Dominio y Rango</h5>
          <div class="buttons">
            <button class="function" onclick="exampleDomainRange('sqrt(9 - x**2 - y**2)')">sqrt(9 - x^2 - y^2)</button>
            <button class="function" onclick="exampleDomainRange('log(x + y)')">log(x + y)</button>
            <button class="function" onclick="exampleDomainRange('1 / (x - y)')">1/(x - y)</button>
            <button class="function" onclick="exampleDomainRange('sqrt(x) + log(y)')">sqrt(x) + log(y)</button>
            <button class="function" onclick="exampleDomainRange('log(x**2 + y**2)')">log(x^2 + y^2)</button>
            <button class="function" onclick="exampleDomainRange('1 / (x**2 + y**2 - 1)')">1/(x^2 + y^2 − 1)</button>
          </div>
        </div>
        <div class="examples-card">
          <h5>Límite en (0,0)</h5>
          <div class="buttons">
            <button class="function" onclick="exampleLimit('(x**2*y) / (x**2 + y**2)',0,0)">(x^2*y)/(x^2+y^2)</button>
            <button class="function" onclick="exampleLimit('(x*y) / (x**2 + y**2)',0,0)">(x*y)/(x^2+y^2)</button>
            <button class="function" onclick="exampleLimit('sin(x*y)',0,0)">sin(x*y)</button>
            <button class="function" onclick="exampleLimit('x**2 + y**2',0,0)">x^2 + y^2</button>
            <button class="function" onclick="exampleLimit('(x**2 + y**2) * sin(1/(x**2 + y**2))',0,0)">(x^2+y^2)·sin(1/(x^2+y^2))</button>
            <button class="function" onclick="exampleLimit('(x*y) / sqrt(x**2 + y**2)',0,0)">(x*y)/√(x^2+y^2)</button>
          </div>
        </div>
        <div class="examples-card">
          <h5>Derivadas y Gradiente</h5>
          <div class="buttons">
            <button class="function" onclick="exampleDeriv('x**2 + y**2',1,-2)">x^2 + y^2 @ (1,-2)</button>
            <button class="function" onclick="exampleDeriv('x*y + x**2',0,3)">x*y + x^2 @ (0,3)</button>
            <button class="function" onclick="exampleDeriv('exp(x) * sin(y)',0,Math.PI/2)">e^x sin(y) @ (0,π/2)</button>
            <button class="function" onclick="exampleDeriv('x**3 - 3*x*y**2',1,1)">x^3 − 3xy^2 @ (1,1)</button>
            <button class="function" onclick="exampleDeriv('sin(x) + cos(y)',0,0)">sin(x) + cos(y) @ (0,0)</button>
            <button class="function" onclick="exampleDeriv('x * exp(-(x**2 + y**2))',0,1)">x·e^{-(x^2+y^2)} @ (0,1)</button>
          </div>
        </div>
        <div class="examples-card">
          <h5>Lagrange (g=0)</h5>
          <div class="buttons">
            <button class="function" onclick="exampleLagrange('x**2 + y**2','x + y = 1')">x^2 + y^2; x+y=1</button>
            <button class="function" onclick="exampleLagrange('x**2 + 4*y**2','x - y = 0')">x^2 + 4y^2; x−y=0</button>
            <button class="function" onclick="exampleLagrange('-x - y','x**2 + y**2 = 1')">−x − y; x^2+y^2=1</button>
            <button class="function" onclick="exampleLagrange('x*y','x + y = 10')">x·y; x+y=10</button>
            <button class="function" onclick="exampleLagrange('x**2 + y**2','x - 2*y = 0')">x^2+y^2; x−2y=0</button>
            <button class="function" onclick="exampleLagrange('x**2 + y**2','x**2 + y**2 = 9')">x^2+y^2; círculo r=3</button>
          </div>
        </div>
        <div class="examples-card">
          <h5>Integrales</h5>
          <div class="buttons">
            <button class="function" onclick="exampleInt2D('x + y',[0,1],[0,1])">∬(x+y) [0,1]x[0,1]</button>
            <button class="function" onclick="exampleInt2D('x**2 + y**2',[-1,1],[0,2])">∬(x^2+y^2) [-1,1]x[0,2]</button>
            <button class="function" onclick="exampleInt2D('sin(x) * cos(y)',[0,Math.PI],[0,Math.PI/2])">∬ sin(x)cos(y)</button>
            <button class="function" onclick="exampleInt2D('exp(-(x**2 + y**2))',[-1,1],[-1,1])">∬ e^{-(x^2+y^2)} [-1,1]^2</button>
            <button class="function" onclick="exampleInt2D('y * sin(x)',[0,Math.PI],[0,1])">∬ y·sin(x) [0,π]x[0,1]</button>
            <button class="function" onclick="exampleInt3D('1',[0,1],[0,1],[0,1])">∭(1) cubo unidad</button>
            <button class="function" onclick="exampleInt3D('x + y + z',[0,1],[0,1],[0,1])">∭(x+y+z) [0,1]^3</button>
            <button class="function" onclick="exampleInt3D('x**2 + y**2',[0,1],[0,1],[0,2])">∭(x^2+y^2) z∈[0,2]</button>
            <button class="function" onclick="exampleInt3D('exp(-(x**2 + y**2 + z**2))',[-1,1],[-1,1],[-1,1])">∭ e^{-(x^2+y^2+z^2)} [-1,1]^3</button>
            <button class="function" onclick="exampleInt3D('sin(x) * cos(y) * exp(-z)',[0,Math.PI],[0,Math.PI/2],[0,2])">∭ sin(x)cos(y)e^{-z}</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
/*
  Calculadora Multivariada (Revisión 3):
  - Se eliminó la dependencia de math.js y function-plot.
  - Se usa JavaScript nativo (eval) y Plotly para garantizar que no haya fallas de carga de CDN.
  - ADVERTENCIA: La funcionalidad simbólica (derivadas, simplificación) no está disponible.
*/

    let displayEl;
    let currentExpression = '0';
    let lastResult = null;
    const scope = {}; // variables asignadas

    // Inicialización inmediata
    document.addEventListener('DOMContentLoaded', () => {
        displayEl = document.getElementById('display');
        refreshDisplay();

        // Atajos: Enter en campos ejecuta acción
        const onEnter = (id, handler) => {
            const el = document.getElementById(id); if (!el) return;
            el.addEventListener('keydown', (ev)=>{ if(ev.key==='Enter'){ handler(); } });
        };
        onEnter('limitAx', ()=>computeLimit2D());
        onEnter('limitBy', ()=>computeLimit2D());
        onEnter('derivX', ()=>showDerivatives());
        onEnter('derivY', ()=>showDerivatives());
        onEnter('lagrangeG', ()=>lagrangeOptimize());
        ['int2dxA','int2dxB','int2dyC','int2dyD'].forEach(id=>onEnter(id, ()=>integralDouble()));
        ['int3dxA','int3dxB','int3dyC','int3dyD','int3dzE','int3dzF'].forEach(id=>onEnter(id, ()=>integralTriple()));
    });

    // Helper: mostrar en display
    function refreshDisplay() {
        if (displayEl) {
            displayEl.textContent = currentExpression;
        }
    }

    // Normalizar expresión (simplificación de sintaxis de usuario a JS nativo)
    function normalize(expr) {
        let text = expr.replace(/×/g, '*').replace(/÷/g, '/');
        // Reemplazar ^ por ** (potencia en JS)
        text = text.replace(/\^/g, '**'); 
        // Eliminar prefijos tipo f(x)= o f(x,y)= si existen
        text = text.replace(/^\s*f\s*\(\s*x\s*\)\s*=\s*/i, '')
                   .replace(/^\s*f\s*\(\s*x\s*,\s*y\s*\)\s*=\s*/i, '')
                   .trim();
        // Mapear funciones a Math.
        text = text.replace(/\b(sin|cos|tan|log|sqrt|exp)\s*\(/g, (m, fn) => `Math.${fn}(`);
        // Mapear constantes pi y e si se escriben como texto
        text = text.replace(/\bpi\b/gi, 'Math.PI').replace(/\bE\b/g, 'Math.E');
        // Reemplazar ans por lastResult
        if (lastResult !== null) {
            text = text.replace(/ans/gi, lastResult);
        }
        // Reemplazar variables del scope (ej: a, b) por sus valores
        for (const key in scope) {
            const regex = new RegExp(`\\b${key}\\b`, 'g');
            text = text.replace(regex, scope[key]);
        }
        return text;
    }

    // --- FUNCIONES DE CALCULADORA ---

    window.addToDisplay = function(value) {
        if (currentExpression === '0' || currentExpression.includes('Error')) {
            currentExpression = value;
        } else {
            currentExpression += value;
        }
        refreshDisplay();
    };

    window.clearDisplay = function() {
        currentExpression = '0';
        refreshDisplay();
    };

    window.backspace = function() {
        if (currentExpression.length > 1) {
            currentExpression = currentExpression.slice(0, -1);
        } else {
            currentExpression = '0';
        }
        refreshDisplay();
    };

    window.useAns = function() {
        if (lastResult !== null) {
            addToDisplay('ans');
        }
    };

    // Asignar variable simple (numérica)
    window.assignVariable = function() {
        const expr = prompt('Escriba asignación (ej: a = 3, b = 2*5)', '');
        if (!expr) return;
        
        try {
            const text = normalize(expr);
            if (text.includes('=')) {
                const [left, right] = text.split('=').map(s => s.trim());
                if (!/^[a-zA-Z_][a-zA-Z0-9_]*$/.test(left)) {
                    alert('Nombre de variable inválido');
                    return;
                }
                // Usar eval para calcular el valor (solo numérico)
                const value = eval(right);
                if (typeof value === 'number' && isFinite(value)) {
                    scope[left] = value;
                    alert(`Asignado: ${left} = ${value}`);
                } else {
                    alert('El valor asignado no es un número válido.');
                }
            } else {
                alert('Use el formato nombre = expresión');
            }
        } catch (e) {
            alert('Error en asignación: ' + e.message);
        }
    };

    window.openAssignModal = window.assignVariable; // alias

    window.toggleLogin = function() {
        const btns = document.querySelectorAll('.login');
        btns.forEach(btn => {
            if (btn.textContent.trim() === 'ABRIR SESIÓN') {
                btn.textContent = 'CERRAR SESIÓN';
                btn.style.background = '#e74c3c';
            } else {
                btn.textContent = 'ABRIR SESIÓN';
                btn.style.background = '#2ecc71';
            }
        });
    };

    // Evaluar expresión (Solo numérica)
    window.calculate = async function() {
        const raw = currentExpression;
        if (!raw || raw.trim() === '0') return;
        try {
            const resp = await fetch('/calculate', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({expression: raw})
            });
            const data = await resp.json();
            if (data.success) {
                lastResult = data.result;
                currentExpression = String(data.result);
            } else {
                throw new Error(data.error || 'Error en cálculo');
            }
        } catch (err) {
            console.error('Error de evaluación:', err);
            currentExpression = 'Error: Sintaxis/Numérico';
        }
        refreshDisplay();
    };

    // Limpia gráficas
    window.clearGraphs = function() {
        document.getElementById('graph2d').innerHTML = '';
        document.getElementById('graph3d').innerHTML = '';
    };

    // Asegurar ejes vacíos si no hay gráfica
    function ensureGraph2D(){
        const gd = document.getElementById('graph2d');
        if (!gd || gd.data) return;
        const xmin = parseFloat(document.getElementById('xmin').value) || -5;
        const xmax = parseFloat(document.getElementById('xmax').value) || 5;
        const ymin = parseFloat(document.getElementById('ymin').value) || -5;
        const ymax = parseFloat(document.getElementById('ymax').value) || 5;
        Plotly.newPlot('graph2d', [], {xaxis:{range:[xmin,xmax], title:'x'}, yaxis:{range:[ymin,ymax], title:'y'}, margin:{l:40,r:10,b:40,t:30}});
    }
    function ensureGraph3D(){
        const gd = document.getElementById('graph3d');
        if (!gd || gd.data) return;
        Plotly.newPlot('graph3d', [], {scene:{xaxis:{title:'x'},yaxis:{title:'y'},zaxis:{title:'z'}, camera:{eye:{x:1.2,y:1.2,z:0.8}}}, margin:{l:40,r:40,b:40,t:40}});
    }


    // Graficar 2D: Usa Plotly para crear una línea de 1D (x, f(x))
    window.plot2D = async function() {
        const raw = currentExpression;
        if (!raw) return alert('Ingrese una función o ecuación en x,y (ej: y=x**2 o x+y=1)');
        let expr = raw;
        try {
            const xmin = parseFloat(document.getElementById('xmin').value) || -5;
            const xmax = parseFloat(document.getElementById('xmax').value) || 5;
            const res = 200; // Resolución para 2D
            const xs = linspace(xmin, xmax, res);
            let data = [];

            // Si es una ecuación con x,y, resolvemos para y en backend
            if (/=/.test(expr) && /x/.test(expr) && /y/.test(expr)) {
                const resp = await fetch('/solve_for_y', {
                    method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({equation: expr})
                });
                const json = await resp.json();
                if (!json.success) throw new Error(json.error || 'No se pudo resolver para y');
                const yExprs = json.y_expressions || [];
                if (yExprs.length === 0) throw new Error('No se obtuvieron formas y(x)');
                for (const ystr of yExprs) {
                    const ys = [];
                    for (let i=0;i<xs.length;i++) {
                        const x = xs[i];
                        let fn = normalize(ystr).replace(/x/g, `(${x})`);
                        let y = NaN; try { const r = eval(fn); if (isFinite(r)) y=r; } catch(_){}
                        ys.push(y);
                    }
                    data.push({x: xs, y: ys, mode:'lines', name: `y=${ystr}`});
                }
            } else {
                // Caso función en x (y = f(x))
                let rawExpr = expr.includes('=') ? expr.split('=')[1].trim() : expr;
                const ys = [];
                for (let i=0;i<xs.length;i++){
                    const x = xs[i];
                    let fn = normalize(rawExpr).replace(/x/g, `(${x})`);
                    let y = NaN; try { const r = eval(fn); if (isFinite(r)) y=r; } catch(_){}
                    ys.push(y);
                }
                data = [{x: xs, y: ys, mode:'lines', name:'y = f(x)', line:{width:3, color:'#2c3e50'}}];
            }

            const layout = {
                title: `f(x) = ${expr}`,
                xaxis: { title: 'x', range: [xmin, xmax], showgrid:true, zeroline:true, gridcolor:'#e1e4e8' },
                yaxis: { title: 'y', range: [parseFloat(document.getElementById('ymin').value) || -5, parseFloat(document.getElementById('ymax').value) || 5], showgrid:true, zeroline:true, gridcolor:'#e1e4e8' },
                margin: { l: 40, r: 10, b: 40, t: 30 },
                paper_bgcolor: 'white', plot_bgcolor: '#fafafa',
                responsive: true
            };

            Plotly.newPlot('graph2d', data, layout);
        } catch (e) {
            alert('Error al graficar 2D: ' + e.message);
            console.error(e);
        }
    };

    // Graficar 3D: usa Plotly para construir una malla z=f(x,y)
    window.plot3D = function() {
        const raw = currentExpression;
        if (!raw) return alert('Ingrese una expresión en x,y (ej: x**2 - y**2) o z = ...');
        let expr = raw.includes('=') ? raw.split('=')[1].trim() : raw;
        
        try {
            const xmin = parseFloat(document.getElementById('xmin').value) || -5;
            const xmax = parseFloat(document.getElementById('xmax').value) || 5;
            const ymin = parseFloat(document.getElementById('ymin').value) || -5;
            const ymax = parseFloat(document.getElementById('ymax').value) || 5;
            const res = Math.max(10, Math.min(150, parseInt(document.getElementById('res3d').value) || 40));

            const xs = linspace(xmin, xmax, res);
            const ys = linspace(ymin, ymax, res);
            const Z = [];

            for (let j = 0; j < ys.length; j++) {
                const y = ys[j];
                const row = [];
                for (let i = 0; i < xs.length; i++) {
                    const x = xs[i];
                    
                    let fn = normalize(expr);
                    // Reemplazar x e y en la expresión para la evaluación
                    fn = fn.replace(/x/g, `(${x})`).replace(/y/g, `(${y})`);

                    let v = NaN;
                    try {
                        const result = eval(fn);
                        if (typeof result === 'number' && isFinite(result)) v = result;
                    } catch (errEval) { /* Mantener NaN */ }
                    // Plotly maneja mejor null que NaN en WebGL
                    row.push((typeof v === 'number' && isFinite(v)) ? v : null);
                }
                Z.push(row);
            }

            const data = [{ 
                z: Z, x: xs, y: ys, type: 'surface', connectgaps: false,
                name: `z = ${expr}`, colorscale: 'Turbo', showscale: true, opacity: 0.95,
                lighting: {ambient: 0.6, diffuse: 0.8, specular: 0.3, roughness: 0.9, fresnel: 0.2},
                lightposition: {x: 100, y: 200, z: 300},
                contours: {z: {show: true, usecolormap: true, highlight: true, project: {x:true, y:true}}}
            }];

            const layout = {
                title: `f(x,y) = ${expr}`,
                autosize: true, margin: {l: 40, r: 40, b: 40, t: 40},
                scene: { xaxis: {title: 'x'}, yaxis: {title: 'y'}, zaxis: {title: 'z'},
                         camera: {eye: {x:1.2, y:1.2, z:0.8}} },
                paper_bgcolor: 'white',
                plot_bgcolor: '#fafafa'
            };

            Plotly.newPlot('graph3d', data, layout, {responsive:true});
        } catch (e) {
            console.error(e);
            alert('Error al graficar 3D: ' + e.message);
        }
    };

    // Dibuja el punto (a,b) con su z en la gráfica 3D
    function addLimitMarker3D(ax, by){
        try{
            ensureGraph3D();
            const raw = currentExpression;
            let expr = raw.includes('=') ? raw.split('=')[1].trim() : raw;
            let fn = normalize(expr).replace(/x/g, `(${ax})`).replace(/y/g, `(${by})`);
            let z = 0; try{ const r = eval(fn); if (typeof r==='number' && isFinite(r)) z = r; }catch(_){ /* keep 0 */ }
            const trace = {type:'scatter3d', mode:'markers', x:[ax], y:[by], z:[z], marker:{size:5, color:'red'}, name:`P(${ax},${by})`};
            Plotly.addTraces('graph3d', [trace]);
        }catch(e){ /* silencioso */ }
    }

    // Dibuja el rectángulo de integración en gráfica 2D (proyección XY)
    function drawIntegrationRegion2D(a,b,c,d){
        try{
            ensureGraph2D();
            const xs = [a,b,b,a,a];
            const ys = [c,c,d,d,c];
            const trace = {type:'scatter', x:xs, y:ys, mode:'lines', fill:'toself', name:`Región [${a},${b}]x[${c},${d}]`, line:{color:'#e67e22'}};
            Plotly.addTraces('graph2d', [trace]);
        }catch(e){ /* silencioso */ }
    }

    // Contornos 2D de z=f(x,y)
    function drawContours2D(){
        const raw = currentExpression; if (!raw) return alert('Ingrese f(x,y)');
        ensureGraph2D();
        try{
            const xmin = parseFloat(document.getElementById('xmin').value) || -5;
            const xmax = parseFloat(document.getElementById('xmax').value) || 5;
            const ymin = parseFloat(document.getElementById('ymin').value) || -5;
            const ymax = parseFloat(document.getElementById('ymax').value) || 5;
            const res = Math.max(40, Math.min(400, parseInt(document.getElementById('res2d').value) || 120));
            const xs = linspace(xmin, xmax, res);
            const ys = linspace(ymin, ymax, res);
            const Z = [];
            let expr = raw.includes('=') ? raw.split('=')[1].trim() : raw;
            for(let j=0;j<ys.length;j++){
                const y = ys[j];
                const row = [];
                for(let i=0;i<xs.length;i++){
                    const x = xs[i];
                    let fn = normalize(expr).replace(/x/g, `(${x})`).replace(/y/g, `(${y})`);
                    let v = null; try{ const r = eval(fn); if (typeof r==='number' && isFinite(r)) v=r; }
                    catch(_){ v=null; }
                    row.push(v);
                }
                Z.push(row);
            }
            const trace = {type:'contour', x:xs, y:ys, z:Z, colorscale:'Viridis', contours:{showlabels:true}, line:{smoothing:0.7}, name:'Contornos z=f(x,y)'};
            Plotly.addTraces('graph2d', [trace]);
        }catch(e){ alert('Error creando contornos: '+e.message); }
    }

    // Heatmap 2D de z=f(x,y)
    function drawHeatmap2D(){
        const raw = currentExpression; if (!raw) return alert('Ingrese f(x,y)');
        ensureGraph2D();
        try{
            const xmin = parseFloat(document.getElementById('xmin').value) || -5;
            const xmax = parseFloat(document.getElementById('xmax').value) || 5;
            const ymin = parseFloat(document.getElementById('ymin').value) || -5;
            const ymax = parseFloat(document.getElementById('ymax').value) || 5;
            const res = Math.max(40, Math.min(400, parseInt(document.getElementById('res2d').value) || 120));
            const xs = linspace(xmin, xmax, res);
            const ys = linspace(ymin, ymax, res);
            const Z = [];
            let expr = raw.includes('=') ? raw.split('=')[1].trim() : raw;
            for(let j=0;j<ys.length;j++){
                const y = ys[j];
                const row = [];
                for(let i=0;i<xs.length;i++){
                    const x = xs[i];
                    let fn = normalize(expr).replace(/x/g, `(${x})`).replace(/y/g, `(${y})`);
                    let v = null; try{ const r = eval(fn); if (typeof r==='number' && isFinite(r)) v=r; }
                    catch(_){ v=null; }
                    row.push(v);
                }
                Z.push(row);
            }
            const trace = {type:'heatmap', x:xs, y:ys, z:Z, colorscale:'RdBu', name:'Heatmap z=f(x,y)'};
            Plotly.addTraces('graph2d', [trace]);
        }catch(e){ alert('Error creando heatmap: '+e.message); }
    }

    function centerCamera3D(){
        try{ Plotly.relayout('graph3d', {scene:{camera:{eye:{x:1.2,y:1.2,z:0.8}, center:{x:0,y:0,z:0}}}}); }
        catch(_){ /* silencioso */ }
    }

    function exportGraphs(){
        try{
            const g2 = document.getElementById('graph2d');
            if (g2 && g2.data && g2.data.length>0) Plotly.downloadImage(g2, {format:'png', filename:'grafica_2d'});
        }catch(_){}
        try{
            const g3 = document.getElementById('graph3d');
            if (g3 && g3.data && g3.data.length>0) Plotly.downloadImage(g3, {format:'png', filename:'grafica_3d'});
        }catch(_){}
    }

    function linspace(a, b, n) {
        const arr = [];
        if (n === 1) return [(a + b)/2];
        const step = (b - a) / (n - 1);
        for (let i = 0; i < n; i++) arr.push(a + step * i);
        return arr;
    }

    // Insertar prefijos F(x) y F(x,y)
    window.insertFx = function(type){
        if (type==='x') {
            currentExpression = 'f(x) = ' + (currentExpression==='0' ? '' : currentExpression);
        } else {
            currentExpression = 'f(x,y) = ' + (currentExpression==='0' ? '' : currentExpression);
        }
        refreshDisplay();
    }

    // ---------- Herramientas avanzadas ----------
    function updateAnalysis(html) {
        const el = document.getElementById('analysisContent');
        if (el) el.innerHTML = html;
    }

    // Recta 2D por dos puntos
    window.plotLine2D = function() {
        try {
            const p1 = prompt('Punto 1 (x,y):', '0,0');
            const p2 = prompt('Punto 2 (x,y):', '1,1');
            if (!p1 || !p2) return;
            const [x1,y1] = p1.split(',').map(Number);
            const [x2,y2] = p2.split(',').map(Number);
            if (![x1,y1,x2,y2].every(v => isFinite(v))) throw new Error('Formato inválido');

            const xmin = parseFloat(document.getElementById('xmin').value) || -5;
            const xmax = parseFloat(document.getElementById('xmax').value) || 5;
            const xs = linspace(xmin, xmax, 200);
            const m = (y2 - y1) / (x2 - x1);
            const b = y1 - m * x1;
            const ys = xs.map(x => m*x + b);

            const data = [{x: xs, y: ys, mode: 'lines', name: `Recta por (${x1},${y1}) y (${x2},${y2})`}];
            const layout = {title: 'Recta 2D', xaxis: {title:'x'}, yaxis: {title:'y'}};
            Plotly.newPlot('graph2d', data, layout);
        } catch(e){ alert('Error creando recta 2D: '+e.message); }
    }

    // Recta 3D por dos puntos
    window.plotLine3D = function() {
        try {
            const p1 = prompt('Punto 1 (x,y,z):', '0,0,0');
            const p2 = prompt('Punto 2 (x,y,z):', '1,1,1');
            if (!p1 || !p2) return;
            const [x1,y1,z1] = p1.split(',').map(Number);
            const [x2,y2,z2] = p2.split(',').map(Number);
            if (![x1,y1,z1,x2,y2,z2].every(v => isFinite(v))) throw new Error('Formato inválido');

            const ts = linspace(0, 1, 100);
            const xs = ts.map(t => x1 + t*(x2 - x1));
            const ys = ts.map(t => y1 + t*(y2 - y1));
            const zs = ts.map(t => z1 + t*(z2 - z1));

            const data = [{
                type: 'scatter3d', mode: 'lines', x: xs, y: ys, z: zs,
                name: 'Recta 3D'
            }];
            const layout = {title: 'Recta 3D', scene: {xaxis:{title:'x'}, yaxis:{title:'y'}, zaxis:{title:'z'}}};
            Plotly.newPlot('graph3d', data, layout);
        } catch(e){ alert('Error creando recta 3D: '+e.message); }
    }

    // Plano 3D ax+by+cz=d
    window.plotPlane3D = function() {
        try {
            const coeffs = prompt('Coeficientes del plano (a,b,c,d) en ax+by+cz=d:', '1,0,0,0');
            if (!coeffs) return;
            const [a,b,c,d] = coeffs.split(',').map(Number);
            if (![a,b,c,d].every(v => isFinite(v))) throw new Error('Formato inválido');

            const xmin = parseFloat(document.getElementById('xmin').value) || -5;
            const xmax = parseFloat(document.getElementById('xmax').value) || 5;
            const ymin = parseFloat(document.getElementById('ymin').value) || -5;
            const ymax = parseFloat(document.getElementById('ymax').value) || 5;
            const xs = linspace(xmin, xmax, 40);
            const ys = linspace(ymin, ymax, 40);
            const Z = [];

            const solveZ = Math.abs(c) > 1e-12;
            const solveY = !solveZ && Math.abs(b) > 1e-12;
            const solveX = !solveZ && !solveY && Math.abs(a) > 1e-12;

            for (let j=0;j<ys.length;j++){
                const y = ys[j];
                const row = [];
                for (let i=0;i<xs.length;i++){
                    const x = xs[i];
                    let z;
                    if (solveZ) z = (d - a*x - b*y)/c;
                    else if (solveY) { z = 0; /* corte z=0 */ }
                    else if (solveX) { z = 0; /* corte z=0 */ }
                    else z = 0;
                    row.push(z);
                }
                Z.push(row);
            }

            const data = [{type:'surface', x: xs, y: ys, z: Z, name:'Plano'}];
            const layout = {title: `Plano: ${a}x+${b}y+${c}z=${d}`, scene:{xaxis:{title:'x'}, yaxis:{title:'y'}, zaxis:{title:'z'}}};
            Plotly.newPlot('graph3d', data, layout);
        } catch(e){ alert('Error creando plano: '+e.message); }
    }

    // Superficie implícita F(x,y,z)=0 usando isosurface
    window.plotImplicit3D = function(){
        const raw = currentExpression;
        if (!raw) return alert('Escribe F(x,y,z)=0 o una expresión de F(x,y,z)');
        let expr = normalize(raw);
        if (expr.includes('=') && !expr.includes('==')){
            const [L,R] = expr.split('=');
            expr = `(${L})-(${R})`;
        }
        try{
            const xmin = parseFloat(document.getElementById('xmin').value) || -5;
            const xmax = parseFloat(document.getElementById('xmax').value) || 5;
            const ymin = parseFloat(document.getElementById('ymin').value) || -5;
            const ymax = parseFloat(document.getElementById('ymax').value) || 5;
            const res = Math.max(12, Math.min(60, parseInt(document.getElementById('res3d').value) || 30));
            const xs = linspace(xmin, xmax, res);
            const ys = linspace(ymin, ymax, res);
            const zs = linspace(xmin, xmax, res);

            const X=[],Y=[],Z=[],VAL=[];
            let vmin=Infinity, vmax=-Infinity;
            for(let k=0;k<zs.length;k++){
                const z = zs[k];
                for(let j=0;j<ys.length;j++){
                    const y = ys[j];
                    for(let i=0;i<xs.length;i++){
                        const x = xs[i];
                        let fn = expr.replace(/x/g, `(${x})`).replace(/y/g, `(${y})`).replace(/z/g, `(${z})`);
                        let v = null;
                        try{ const r = eval(fn); if (typeof r==='number' && isFinite(r)) v=r; else v=null; }catch(err){ v=null; }
                        X.push(x); Y.push(y); Z.push(z); VAL.push(v);
                        if (typeof v==='number' && isFinite(v)){ if (v<vmin) vmin=v; if (v>vmax) vmax=v; }
                    }
                }
            }

            const data=[{type:'isosurface', x:X, y:Y, z:Z, value:VAL, isomin:vmin, isomax:vmax, isolevel:0, caps:{x:false,y:false,z:false}, colorscale:'Viridis', showscale:false, name:'F(x,y,z)=0'}];
            const layout={title:'Superficie implícita (nivel 0)', scene:{xaxis:{title:'x'}, yaxis:{title:'y'}, zaxis:{title:'z'}}};
            Plotly.newPlot('graph3d', data, layout);
        }catch(e){ alert('Error graficando implícita: '+e.message); }
    }

    // Cuádricas rápidas
    window.loadQuadric = function(type){
        if (type==='sphere'){
            const r = parseFloat(prompt('Radio de la esfera (R):', '3'));
            if (!isFinite(r)) return;
            currentExpression = `x**2 + y**2 + z**2 = ${r*r}`;
            refreshDisplay();
            plotImplicit3D();
        } else if (type==='ellipsoid'){
            const a = parseFloat(prompt('a:', '3')); const b=parseFloat(prompt('b:', '2')); const c=parseFloat(prompt('c:', '1'));
            if (![a,b,c].every(v=>isFinite(v))) return;
            currentExpression = `(x**2/${a*a}) + (y**2/${b*b}) + (z**2/${c*c}) = 1`;
            refreshDisplay(); plotImplicit3D();
        } else if (type==='paraboloid'){
            const a = parseFloat(prompt('Coeficiente a (x^2/a^2):', '1'));
            const b = parseFloat(prompt('Coeficiente b (y^2/b^2):', '1'));
            if (![a,b].every(v=>isFinite(v))) return;
            currentExpression = `(x**2/${a*a}) + (y**2/${b*b})`;
            refreshDisplay(); plot3D();
        } else if (type==='hyperboloid1'){
            currentExpression = `(x**2) + (y**2) - (z**2) = 1`;
            refreshDisplay(); plotImplicit3D();
        } else if (type==='hyperboloid2'){
            currentExpression = `(z**2) - (x**2) - (y**2) = 1`;
            refreshDisplay(); plotImplicit3D();
        }
    }

    // Optimización de f(x,y): gradiente, puntos críticos y clasificación
    window.optimizeFn = async function(){
        const raw = currentExpression;
        let expr = raw.includes('=') ? raw.split('=')[1].trim() : raw;
        expr = normalize(expr);
        try{
            const resp = await fetch('/optimize', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({func: expr})});
            const data = await resp.json();
            if (!data.success) throw new Error(data.error || 'Error desconocido');
            const html = `
                <div><b>Gradiente:</b> ${data.gradient_latex}</div>
                <div><b>Hessiano:</b> ${data.hessian_latex}</div>
                <div><b>Puntos críticos:</b> ${data.critical_points_latex.join('<br/>') || '—'}</div>
                <div><b>Clasificación:</b> ${data.classification.join('<br/>') || '—'}</div>
            `;
            updateAnalysis(html);
        }catch(e){ updateAnalysis('Error: '+e.message); }
    }

    window.helpDialog = function() {
        alert(
`Ayuda rápida:
- Evaluar: escribe la expresión y pulsa '='.
- Asignar variable: usa "a = 3" o pulsa "ASIG".
- Graficar 2D: la función debe depender de 'x' (ej: Math.sin(x)).
- Graficar 3D: la expresión debe usar 'x', 'y' (ej: x**2 + y**2).
- Notación: Usa '**' para potencias (ej: x**2). Usa 'Math.' antes de funciones trigonométricas (ej: Math.sin()).
LIMITACIÓN:
- La funcionalidad de Derivadas (simbólicas) y simplificación NO está disponible.`
        );
    };

    // -------- Modal de ejemplos --------
    window.openExamples = function(){
        const m = document.getElementById('examplesModal'); if (m) m.style.display='flex';
    }
    window.closeExamples = function(ev){
        const m = document.getElementById('examplesModal'); if (m) m.style.display='none';
    }

    function setExprAndDisplay(expr){ currentExpression = expr; refreshDisplay(); }
    // Acciones por tema
    window.examplePlot3D = function(expr){ setExprAndDisplay('f(x,y) = ' + expr); closeExamples(); plot3D(); }
    window.exampleDomainRange = function(expr){ setExprAndDisplay('f(x,y) = ' + expr); closeExamples(); analyzeDomainRange(); }
    window.exampleLimit = function(expr,a,b){ setExprAndDisplay('f(x,y) = ' + expr); closeExamples(); computeLimit2DPreset(a,b); }
    window.exampleDeriv = function(expr,a,b){ setExprAndDisplay('f(x,y) = ' + expr); closeExamples(); showDerivativesPreset(a,b); }
    window.exampleLagrange = function(f,g){ setExprAndDisplay('f(x,y) = ' + f); closeExamples(); lagrangePreset(f,g); }
    window.exampleInt2D = function(expr, bx, by){ setExprAndDisplay('f(x,y) = ' + expr); closeExamples(); integralDoublePreset(bx, by); }
    window.exampleInt3D = function(expr, bx, by, bz){ setExprAndDisplay('f(x,y,z) = ' + expr); closeExamples(); integralTriplePreset(bx, by, bz); }

    // Helpers para llamar endpoints sin prompts
    window.computeLimit2DPreset = async function(a,b){
        const raw = currentExpression; try{
            const resp = await fetch('/limit2d', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({expression: raw, a, b})});
            const data = await resp.json(); if(!data.success) throw new Error(data.error||'Error límite');
            const val = data.limit_estimate==null ? 'No estimado' : data.limit_estimate;
            updateAnalysis(`<div><b>Lim f(x,y)→(${a},${b}):</b> ${val}</div><div>Convergencia (4 rutas): ${data.converges?'Sí':'No'}</div>`);
        }catch(e){ updateAnalysis('Error: '+e.message); }
    }

    window.showDerivativesPreset = async function(a,b){
        const raw = currentExpression; try{
            const resp = await fetch('/derivatives', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({expression: raw, point:{x:a, y:b}})});
            const data = await resp.json(); if(!data.success) throw new Error(data.error||'Error derivadas');
            let html = `<div><b>∂f/∂x:</b> ${data.fx_latex}</div><div><b>∂f/∂y:</b> ${data.fy_latex}</div><div><b>Hessiano:</b> ${data.hessian_latex}</div>`;
            if (data.grad_at_point) html += `<div><b>∇f(${a},${b}):</b> (${data.grad_at_point[0]}, ${data.grad_at_point[1]})</div>`;
            updateAnalysis(html);
        }catch(e){ updateAnalysis('Error: '+e.message); }
    }

    window.lagrangePreset = async function(f,g){
        try{
            const resp = await fetch('/lagrange', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({f, g})});
            const data = await resp.json(); if(!data.success) throw new Error(data.error||'Error Lagrange');
            const pts = (data.points||[]).map(p=>`(${p.x}, ${p.y})`).join(', ') || '—';
            updateAnalysis(`<div><b>f:</b> ${data.latex.f}</div><div><b>g:</b> ${data.latex.g}</div><div><b>Puntos candidatos:</b> ${pts}</div>`);
        }catch(e){ updateAnalysis('Error: '+e.message); }
    }

    window.integralDoublePreset = async function(bx,by){
        const raw = currentExpression; try{
            const resp = await fetch('/integral2d', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({expression: raw, bounds:{x:bx, y:by}})});
            const data = await resp.json(); if(!data.success) throw new Error(data.error||'Error integral 2D');
            updateAnalysis(`<div><b>∬ f(x,y) dx dy:</b> ${data.result}</div><div>Simbolico:</div><div>${data.latex}</div>`);
        }catch(e){ updateAnalysis('Error: '+e.message); }
    }

    window.integralTriplePreset = async function(bx,by,bz){
        const raw = currentExpression; try{
            const resp = await fetch('/integral3d', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({expression: raw, bounds:{x:bx, y:by, z:bz}})});
            const data = await resp.json(); if(!data.success) throw new Error(data.error||'Error integral 3D');
            updateAnalysis(`<div><b>∭ f(x,y,z) dV:</b> ${data.result}</div><div>Simbolico:</div><div>${data.latex}</div>`);
        }catch(e){ updateAnalysis('Error: '+e.message); }
    }

    // ---- Nuevo: Dominio y Rango ----
    window.analyzeDomainRange = async function(){
        const raw = currentExpression; if (!raw) return alert('Ingrese f(x,y) o z = f(x,y)');
        try{
            const xmin = parseFloat(document.getElementById('xmin').value) || -5;
            const xmax = parseFloat(document.getElementById('xmax').value) || 5;
            const ymin = parseFloat(document.getElementById('ymin').value) || -5;
            const ymax = parseFloat(document.getElementById('ymax').value) || 5;
            const resp = await fetch('/domain_range', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({expression: raw, x_range:[xmin,xmax], y_range:[ymin,ymax], samples:70})});
            const data = await resp.json();
            if (!data.success) throw new Error(data.error || 'Error dominio/rango');
            updateAnalysis(`<div><b>Dominio (puntos válidos en malla):</b> ${data.domain_points}</div>
                <div><b>Rango aproximado:</b> [${data.range_min}, ${data.range_max}]</div>`);
        }catch(e){ updateAnalysis('Error: '+e.message); }
    }

    // Visualiza el dominio como una máscara de puntos válidos (proyección XY)
    window.drawDomainMask2D = function(){
        const raw = currentExpression; if (!raw) return alert('Ingrese f(x,y)');
        ensureGraph2D();
        try{
            const xmin = parseFloat(document.getElementById('xmin').value) || -5;
            const xmax = parseFloat(document.getElementById('xmax').value) || 5;
            const ymin = parseFloat(document.getElementById('ymin').value) || -5;
            const ymax = parseFloat(document.getElementById('ymax').value) || 5;
            const res = 50;
            const xs = linspace(xmin, xmax, res);
            const ys = linspace(ymin, ymax, res);
            const X=[]; const Y=[];
            let expr = raw.includes('=') ? raw.split('=')[1].trim() : raw;
            for (let j=0;j<ys.length;j++){
                const y = ys[j];
                for(let i=0;i<xs.length;i++){
                    const x = xs[i];
                    let fn = normalize(expr).replace(/x/g, `(${x})`).replace(/y/g, `(${y})`);
                    try{ const r = eval(fn); if (typeof r==='number' && isFinite(r)){ X.push(x); Y.push(y); } }catch(_){ /* fuera de dominio */ }
                }
            }
            const trace = {type:'scatter', x:X, y:Y, mode:'markers', marker:{size:3, color:'#16a085', opacity:0.7}, name:'Dominio (válidos)'};
            Plotly.addTraces('graph2d', [trace]);
        }catch(e){ alert('Error graficando dominio 2D: '+e.message); }
    }

    // ---- Nuevo: Límite 2D ----
    window.computeLimit2D = async function(){
        const raw = currentExpression; if (!raw) return alert('Ingrese f(x,y)');
        const ax = parseFloat(document.getElementById('limitAx').value);
        const by = parseFloat(document.getElementById('limitBy').value);
        if (![ax,by].every(v=>isFinite(v))) return updateAnalysis('Error: valores (a,b) inválidos');
        try{
            const resp = await fetch('/limit2d', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({expression: raw, a: ax, b: by})});
            const data = await resp.json(); if (!data.success) throw new Error(data.error || 'Error límite');
            const val = data.limit_estimate==null ? 'No estimado' : data.limit_estimate;
            updateAnalysis(`<div><b>Lim f(x,y)→(${ax},${by}):</b> ${val}</div>
                <div>Convergencia (4 rutas): ${data.converges ? 'Sí' : 'No'}</div>`);
            // Visualizar punto en 3D
            addLimitMarker3D(ax, by);
        }catch(e){ updateAnalysis('Error: '+e.message); }
    }

    // ---- Nuevo: Derivadas y Gradiente ----
    window.showDerivatives = async function(){
        const raw = currentExpression; if (!raw) return alert('Ingrese f(x,y)');
        const dx = document.getElementById('derivX').value;
        const dy = document.getElementById('derivY').value;
        let point = null;
        if (dx !== '' && dy !== ''){
            const a = parseFloat(dx), b = parseFloat(dy);
            if([a,b].every(v=>isFinite(v))) point = {x:a, y:b};
        }
        try{
            const resp = await fetch('/derivatives', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({expression: raw, point})});
            const data = await resp.json(); if(!data.success) throw new Error(data.error || 'Error derivadas');
            let html = `<div><b>∂f/∂x:</b> ${data.fx_latex}</div><div><b>∂f/∂y:</b> ${data.fy_latex}</div><div><b>Hessiano:</b> ${data.hessian_latex}</div>`;
            if (data.grad_at_point) html += `<div><b>∇f(${point?point.x:'a'},${point?point.y:'b'}):</b> (${data.grad_at_point[0]}, ${data.grad_at_point[1]})</div>`;
            updateAnalysis(html);

            // Visualización del gradiente como flecha en 3D (si hay punto)
            if (point && data.grad_at_point){
                const gx = data.grad_at_point[0];
                const gy = data.grad_at_point[1];
                // calcular z en el punto
                let expr = raw.includes('=') ? raw.split('=')[1].trim() : raw;
                let z0 = 0; try{
                    const fn = normalize(expr).replace(/x/g, `(${point.x})`).replace(/y/g, `(${point.y})`);
                    const r = eval(fn); if (typeof r==='number' && isFinite(r)) z0 = r;
                }catch(_){ /* leave 0 */ }
                const scale = 0.4; // escala visual
                const x2 = point.x + scale*gx;
                const y2 = point.y + scale*gy;
                ensureGraph3D();
                const arrow = {
                    type: 'scatter3d', mode: 'lines+markers',
                    x: [point.x, x2], y: [point.y, y2], z: [z0, z0],
                    line: {color: '#c0392b', width: 6},
                    marker: {size: 3, color: '#c0392b'},
                    name: '∇f (dirección máxima subida)'
                };
                const pmark = {type:'scatter3d', mode:'markers', x:[point.x], y:[point.y], z:[z0], marker:{size:5, color:'#2980b9'}, name:`P(${point.x},${point.y})`};
                Plotly.addTraces('graph3d', [pmark, arrow]);
            }
        }catch(e){ updateAnalysis('Error: '+e.message); }
    }

    // ---- Nuevo: Lagrange ----
    window.lagrangeOptimize = async function(){
        const raw = currentExpression; if (!raw) return alert('Ingrese f(x,y)');
        const g = document.getElementById('lagrangeG').value || 'x + y = 1';
        try{
            const resp = await fetch('/lagrange', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({f: raw, g})});
            const data = await resp.json(); if(!data.success) throw new Error(data.error || 'Error Lagrange');
            const pts = (data.points||[]).map(p=>`(${p.x}, ${p.y})`).join(', ') || '—';
            updateAnalysis(`<div><b>f:</b> ${data.latex.f}</div><div><b>g:</b> ${data.latex.g}</div><div><b>Puntos candidatos:</b> ${pts}</div>`);
        }catch(e){ updateAnalysis('Error: '+e.message); }
    }

    // ---- Nuevo: Integrales ----
    window.integralDouble = async function(){
        const raw = currentExpression; if (!raw) return alert('Ingrese f(x,y)');
        const a = parseFloat(document.getElementById('int2dxA').value);
        const b = parseFloat(document.getElementById('int2dxB').value);
        const c = parseFloat(document.getElementById('int2dyC').value);
        const d = parseFloat(document.getElementById('int2dyD').value);
        if(![a,b,c,d].every(v=>isFinite(v))) return updateAnalysis('Error: límites ∬ inválidos');
        try{
            const resp = await fetch('/integral2d', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({expression: raw, bounds:{x:[a,b], y:[c,d]}})});
            const data = await resp.json(); if(!data.success) throw new Error(data.error || 'Error integral 2D');
            updateAnalysis(`<div><b>∬ f(x,y) dx dy:</b> ${data.result}</div><div>Simbolico:</div><div>${data.latex}</div>`);
            // Dibujar región en 2D
            drawIntegrationRegion2D(a,b,c,d);
        }catch(e){ updateAnalysis('Error: '+e.message); }
    }

    window.integralTriple = async function(){
        const raw = currentExpression; if (!raw) return alert('Ingrese f(x,y,z)');
        const a = parseFloat(document.getElementById('int3dxA').value);
        const b = parseFloat(document.getElementById('int3dxB').value);
        const c = parseFloat(document.getElementById('int3dyC').value);
        const d = parseFloat(document.getElementById('int3dyD').value);
        const e = parseFloat(document.getElementById('int3dzE').value);
        const f = parseFloat(document.getElementById('int3dzF').value);
        if(![a,b,c,d,e,f].every(v=>isFinite(v))) return updateAnalysis('Error: límites ∭ inválidos');
        try{
            const resp = await fetch('/integral3d', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({expression: raw, bounds:{x:[a,b], y:[c,d], z:[e,f]}})});
            const data = await resp.json(); if(!data.success) throw new Error(data.error || 'Error integral 3D');
            updateAnalysis(`<div><b>∭ f(x,y,z) dV:</b> ${data.result}</div><div>Simbolico:</div><div>${data.latex}</div>`);
        }catch(e){ updateAnalysis('Error: '+e.message); }
    }

</script>
</body>
</html>
